<!DOCTYPE html>
<html>
    <head>
        <title>Sketch</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="Sketch.css">
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    </head>
    <body style="background-color: lightsalmon;">
        <div class="container">
            <div class="row">
                <canvas class="imagedisplay"></canvas>
            </div>
            
            <script type="text/javascript">
(function() {    
    const script = $(document.currentScript);
    const container = script.closest('.container');
    
    const canvas = container.find('.imagedisplay');
    
    let lines = [];
    let touches = [];
    let currentLine = [];
    
    const redraw = function() {
        let width = canvas.parent().width();
        let height = $(window).height() * .9;
        
        let size = Math.min(width, height);
    
        canvas.width(size);
        canvas.height(size);
        canvas.prop("width", size);
        canvas.prop("height", size);
        
        let ctx = canvas.get(0).getContext("2d");
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, size, size);
        
        ctx.strokeStyle="black";
        if (lines.length > 0) {
            lines.forEach((line)=>{
                if (line.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(size * line[1][0], size * line[1][1]);
                    
                    line.forEach((point) => {
                        ctx.lineTo(size * point[0], size * point[1]);
                        
                    });
                    ctx.stroke();
                }
            });
        }
                
    };
        
    const drawStart = function(point) {
        currentLine = [point];
        
        lines.push(currentLine);
        redraw();
    };
    
    const drawEnd = function(point) {
        currentLine.push(point);
        redraw();
    };
    
    const draw = function(point) {
        currentLine.push(point);
        redraw();
    };
    
    
    const mouseStart = function(event) {
        event.preventDefault();
        let point = normalize(eventLocation(event));        
        drawStart(point);
    };
    
    const mouseEnd = function(event) {
        event.preventDefault();
        let point = normalize(eventLocation(event));        
        drawEnd(point);
    };
    
    const mouseMove = function(event) {
        if (event.which === 1) {
            event.preventDefault();
            let point = normalize(eventLocation(event));            
            draw(point);
        }
    };
    
    const touchStart = function(event) {
        event.preventDefault();
        
        for (let i = 0; i < event.changedTouches.length; i++) {
            let touch = event.changedTouches[i];
            let points = [normalize(eventLocation(touch))];
            lines.push(points);
            touches.push({"id": touch.identifier, "points": points}); 
        }
        redraw();
    };
    
    const touchEnd = function(event) { 
        event.preventDefault();
        
        for (let j = 0; j < event.changedTouches.length; j++) {
            let touch = event.changedTouches[j];
            
            for (let i = touches.length - 1; i >= 0; i--) {
                if (touches[i].id === touch.identifier) {
                    let point = normalize(eventLocation(touch));
                    
                    touches[i].points.push(normalize(eventLocation(touch)));
                    touches.splice(i, 1);
                }
            }
        }
        
        redraw();
    };
    
    const touchMove = function(event) {
        event.preventDefault();
        
        for (let j = 0; j < event.changedTouches.length; j++) {
            let touch = event.changedTouches[j];
                        
            for (let i = touches.length - 1; i >= 0; i--) {
                if (touches[i].id === touch.identifier) {
                    let point = normalize(eventLocation(touch));
                    
                    touches[i].points.push(point);
                }
            }
        }
        
//        console.log(touches);
        redraw();
    };
    
    function eventLocation(e) {
        e = e || window.event;

        let target = e.target || e.srcElement,
            style = target.currentStyle || window.getComputedStyle(target, null),
            borderLeftWidth = parseInt(style['borderLeftWidth'], 10),
            borderTopWidth = parseInt(style['borderTopWidth'], 10),
            rect = target.getBoundingClientRect(),
            offsetX = e.clientX - borderLeftWidth - rect.left,
            offsetY = e.clientY - borderTopWidth - rect.top;

        return [offsetX, offsetY];
    }
    
    function normalize(point) {
        let width = canvas.width();
        let height = canvas.height();
        
        return [point[0] / width, point[1] / height];
    }
    
    $(document).resize(() => {
        redraw();
    });

    canvas.on("mousedown", mouseStart);
    canvas.on("mouseup", mouseEnd);
    canvas.on("mousemove", mouseMove);
    canvas.on("touchstart", touchStart);
    canvas.on("touchend", touchEnd);
    canvas.on("touchmove", touchMove);
    
    redraw();
})();


            </script>
        </div>
    </body>
</html>
